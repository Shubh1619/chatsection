{% extends "base.html" %}
{% block title %}Chat{% endblock %}
{% block content %}
<h4>Chat with {{ other_user }}</h4>
<div class="card">
    <div class="card-body" id="chat-box" style="height: 400px; overflow-y: auto;">
        {% for msg in messages %}
            <div><strong>{{ msg.sender }}:</strong> {{ msg.content }} <span class="text-muted small">{{ msg.timestamp.strftime('%Y-%m-%d %H:%M') }}</span></div>
        {% endfor %}
    </div>
    <div class="card-footer">
        <form id="chat-form">
            <div class="input-group">
                <input type="text" class="form-control" id="chat-input" placeholder="Type a message...">
                <button class="btn btn-primary" type="submit">Send</button>
            </div>
        </form>
    </div>
</div>
<script>
    const socket = new WebSocket(`ws://${location.host}/ws/chat/{{ other_user }}?username={{ current_user }}`);
    const chatBox = document.getElementById("chat-box");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");

    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const div = document.createElement("div");
        div.innerHTML = `<strong>${data.from}:</strong> ${data.message}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    };

chatForm.addEventListener("submit", function(e) {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (message !== "") {
        socket.send(JSON.stringify({ from: "{{ current_user }}", message: message }));
        
        // Show sender's message immediately
        const div = document.createElement("div");
        div.innerHTML = `<strong>You:</strong> ${message}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;

        chatInput.value = "";
    }
});

</script>
{% endblock %}